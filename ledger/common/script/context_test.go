// Copyright 2025 Blink Labs Software
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package script

import (
	"encoding/hex"
	"errors"
	"fmt"
	"regexp"
	"strings"
	"testing"
	"time"

	"github.com/blinklabs-io/gouroboros/cbor"
	"github.com/blinklabs-io/gouroboros/ledger/babbage"
	"github.com/blinklabs-io/gouroboros/ledger/common"
	lcommon "github.com/blinklabs-io/gouroboros/ledger/common"
	"github.com/blinklabs-io/gouroboros/ledger/conway"
	"github.com/blinklabs-io/gouroboros/ledger/shelley"
	"github.com/blinklabs-io/plutigo/data"
)

func formatPlutusData(pd data.PlutusData) string {
	var builder strings.Builder
	pdStr := pd.String()
	indentLevel := 0
	needsNewline := false
	for _, c := range pdStr {
		if c == ' ' && needsNewline {
			builder.WriteString("\n" + strings.Repeat(` `, indentLevel*4))
			continue
		}
		needsNewline = false
		if c == '{' || c == '[' {
			indentLevel++
			needsNewline = true
		}
		if c == '}' || c == ']' {
			indentLevel--
			builder.WriteString("\n" + strings.Repeat(` `, indentLevel*4))
			needsNewline = true
		}
		if c == ')' {
			needsNewline = true
		}
		if c == ',' {
			needsNewline = true
		}
		builder.WriteRune(c)
		if needsNewline {
			builder.WriteString("\n" + strings.Repeat(` `, indentLevel*4))
		}
	}
	ret := builder.String()
	// Strip out empty lines
	tmpRe := regexp.MustCompile(`\n +\n`)
	ret = tmpRe.ReplaceAllString(ret, "\n")
	return ret
}

func buildTxInfoV3(
	slotState lcommon.SlotState,
	txHex string,
	inputsHex string,
	inputOutputsHex string,
) (TxInfo, error) {
	// Transaction
	txBytes, err := hex.DecodeString(txHex)
	if err != nil {
		return nil, fmt.Errorf("decode transaction hex: %w", err)
	}
	tx, err := conway.NewConwayTransactionFromCbor(txBytes)
	if err != nil {
		return nil, err
	}
	// Inputs
	inputsBytes, err := hex.DecodeString(inputsHex)
	if err != nil {
		return nil, fmt.Errorf("decode inputs hex: %w", err)
	}
	var tmpInputs []shelley.ShelleyTransactionInput
	if _, err := cbor.Decode(inputsBytes, &tmpInputs); err != nil {
		return nil, fmt.Errorf("decode inputs: %w", err)
	}
	// Input outputs
	inputOutputsBytes, err := hex.DecodeString(inputOutputsHex)
	if err != nil {
		return nil, fmt.Errorf("decode input outputs hex: %w", err)
	}
	var tmpOutputs []babbage.BabbageTransactionOutput
	if _, err := cbor.Decode(inputOutputsBytes, &tmpOutputs); err != nil {
		return nil, fmt.Errorf("decode input outputs: %w", err)
	}
	// Build resolved inputs
	var resolvedInputs []lcommon.Utxo
	if len(tmpInputs) != len(tmpOutputs) {
		return nil, errors.New("input and output length don't match")
	}
	for i := range tmpInputs {
		resolvedInputs = append(
			resolvedInputs,
			lcommon.Utxo{
				Id:     tmpInputs[i],
				Output: tmpOutputs[i],
			},
		)
	}
	// Build TxInfo
	txInfo, err := NewTxInfoV3FromTransaction(slotState, tx, resolvedInputs)
	if err != nil {
		return nil, err
	}
	return txInfo, nil
}

type mockSlotState struct {
	ZeroTime   time.Time
	ZeroSlot   uint64
	SlotLength time.Duration
}

func (m mockSlotState) SlotToTime(slot uint64) (time.Time, error) {
	slot -= m.ZeroSlot
	ret := m.ZeroTime.Add(time.Duration(slot) * m.SlotLength)
	return ret, nil
}

func (m mockSlotState) TimeToSlot(t time.Time) (uint64, error) {
	// TODO
	return 0, nil
}

var preprodSlotState = mockSlotState{
	SlotLength: 1 * time.Second,
	// Shelley start
	ZeroTime: time.UnixMilli(1596059091000),
	ZeroSlot: 4492800,
}

var scriptContextV3TestDefs = []struct {
	name          string
	txHex         string
	inputsHex     string
	outputsHex    string
	redeemerTag   common.RedeemerTag
	redeemerIndex uint32
	slotState     common.SlotState
	expectedCbor  string
}{
	{
		name:          "SimpleSend",
		txHex:         `84a70081825820000000000000000000000000000000000000000000000000000000000000000000018182581d60111111111111111111111111111111111111111111111111111111111a3b9aca0002182a0b5820ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0d818258200000000000000000000000000000000000000000000000000000000000000000001082581d60000000000000000000000000000000000000000000000000000000001a3b9aca001101a20581840000d87980821a000f42401a05f5e100078152510101003222253330044a229309b2b2b9a1f5f6`,
		inputsHex:     `81825820000000000000000000000000000000000000000000000000000000000000000000`,
		outputsHex:    `81a300581d7039f47fd3b388ef53c48f08de24766d3e55dade6cae908cc24e0f4f3e011a3b9aca00028201d81843d87980`,
		redeemerTag:   common.RedeemerTagSpend,
		redeemerIndex: 0,
		expectedCbor:  `d8799fd8799f9fd8799fd8799f5820000000000000000000000000000000000000000000000000000000000000000000ffd8799fd8799fd87a9f581c39f47fd3b388ef53c48f08de24766d3e55dade6cae908cc24e0f4f3effd87a80ffa140a1401a3b9aca00d87b9fd87980ffd87a80ffffff809fd8799fd8799fd8799f581c11111111111111111111111111111111111111111111111111111111ffd87a80ffa140a1401a3b9aca00d87980d87a80ffff182aa080a0d8799fd8799fd87980d87a80ffd8799fd87b80d87a80ffff80a1d87a9fd8799f5820000000000000000000000000000000000000000000000000000000000000000000ffffd87980a0582078ec148ea647cf9969446891af31939c5d57b275a2455706782c6183ef0b62f1a080d87a80d87a80ffd87980d87a9fd8799f5820000000000000000000000000000000000000000000000000000000000000000000ffd8799fd87980ffffff`,
	},
	{
		name: "Mint",
		txHex: "84a9008182582000000000000000000000000000000000000000000000000000" +
			"00000000000000000183a300581d600000000000000000000000000000000000" +
			"0000000000000000000000011a000f42400282005820923918e403bf43c34b4e" +
			"f6b48eb2ee04babed17320d8d1b9ff9ad086e86f44eca2005839000000000000" +
			"0000000000000000000000000000000000000000000000000000000000000000" +
			"0000000000000000000000000000000000000001821a000f4240a2581c12593b" +
			"4cbf7fdfd8636db99fe356437cd6af8539aadaa0a401964874a14474756e611b" +
			"00005af3107a4000581c0c8eaf490c53afbf27e3d84a3b57da51fbafe5aa7844" +
			"3fcec2dc262ea14561696b656e182aa300583910000000000000000000000000" +
			"0000000000000000000000000000000000000000000000000000000000000000" +
			"00000000000000000000000001821a000f4240a1581c0c8eaf490c53afbf27e3" +
			"d84a3b57da51fbafe5aa78443fcec2dc262ea14763617264616e6f0103d81847" +
			"82034463666f6f02182a09a2581c12593b4cbf7fdfd8636db99fe356437cd6af" +
			"8539aadaa0a401964874a14474756e611b00005af3107a4000581c0c8eaf490c" +
			"53afbf27e3d84a3b57da51fbafe5aa78443fcec2dc262ea24763617264616e6f" +
			"014561696b656e2d0b5820ffffffffffffffffffffffffffffffffffffffffff" +
			"ffffffffffffffffffffff0d8182582000000000000000000000000000000000" +
			"00000000000000000000000000000000001082581d6000000000000000000000" +
			"0000000000000000000000000000000000001a3b9aca00110112818258200000" +
			"00000000000000000000000000000000000000000000000000000000000000a3" +
			"0582840100d87980821a000f42401a05f5e100840101182a821a000f42401a05" +
			"f5e1000481d879800782587d587b010100323232323232322533333300800115" +
			"3330033370e900018029baa001153330073006375400224a6660089445261533" +
			"0054911856616c696461746f722072657475726e65642066616c736500136560" +
			"02002002002002002153300249010b5f746d70323a20566f696400165734ae71" +
			"55ceaab9e5573eae915895589301010032323232323232253333330080011533" +
			"30033370e900018029baa001153330073006375400224a666008a6600a920110" +
			"5f5f5f5f5f6d696e745f325f5f5f5f5f0014a22930a99802a4811856616c6964" +
			"61746f722072657475726e65642066616c736500136560020020020020020021" +
			"53300249010b5f746d70323a20566f696400165734ae7155ceaab9e5573eae91" +
			"f5f6",
		inputsHex:     "81825820000000000000000000000000000000000000000000000000000000000000000000",
		outputsHex:    "81a200581d6000000000000000000000000000000000000000000000000000000000011a000f4240",
		redeemerTag:   common.RedeemerTagMint,
		redeemerIndex: 1,
		expectedCbor:  "d8799fd8799f9fd8799fd8799f5820000000000000000000000000000000000000000000000000000000000000000000ffd8799fd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a80ffa140a1401a000f4240d87980d87a80ffffff9fd8799fd8799f5820000000000000000000000000000000000000000000000000000000000000000000ffd8799fd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a80ffa140a1401a000f4240d87980d87a80ffffff9fd8799fd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a80ffa140a1401a000f4240d87a9f5820923918e403bf43c34b4ef6b48eb2ee04babed17320d8d1b9ff9ad086e86f44ecffd87a80ffd8799fd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffd8799fd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffffffffa340a1401a000f4240581c0c8eaf490c53afbf27e3d84a3b57da51fbafe5aa78443fcec2dc262ea14561696b656e182a581c12593b4cbf7fdfd8636db99fe356437cd6af8539aadaa0a401964874a14474756e611b00005af3107a4000d87980d87a80ffd8799fd8799fd87a9f581c00000000000000000000000000000000000000000000000000000000ffd8799fd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffffffffa240a1401a000f4240581c0c8eaf490c53afbf27e3d84a3b57da51fbafe5aa78443fcec2dc262ea14763617264616e6f01d87980d8799f581c68ad54b3a8124d9fe5caaaf2011a85d72096e696a2fb3d7f86c41717ffffff182aa2581c0c8eaf490c53afbf27e3d84a3b57da51fbafe5aa78443fcec2dc262ea24561696b656e2d4763617264616e6f01581c12593b4cbf7fdfd8636db99fe356437cd6af8539aadaa0a401964874a14474756e611b00005af3107a400080a0d8799fd8799fd87980d87a80ffd8799fd87b80d87a80ffff80a2d8799f581c0c8eaf490c53afbf27e3d84a3b57da51fbafe5aa78443fcec2dc262effd87980d8799f581c12593b4cbf7fdfd8636db99fe356437cd6af8539aadaa0a401964874ff182aa15820923918e403bf43c34b4ef6b48eb2ee04babed17320d8d1b9ff9ad086e86f44ecd879805820e757985e48e43a95a185ddba08c814bc20f81cb68544ac937a9b992e4e6c38a0a080d87a80d87a80ff182ad8799f581c12593b4cbf7fdfd8636db99fe356437cd6af8539aadaa0a401964874ffff",
	},
	{
		name:          "SendWithRequiredSigners",
		txHex:         "84a90081825820c9f355431b2546acfc03b11540dc8bee31b9afc5674081a61cc39e0845380e7a000181825839009fc430ea1f3adc20eebb813b2649e85c934ea5bc13d7b7fbe2b24e505064b671634d14cb8d543e71dd8eb437a47efb47b0b22882866c420d1a009569e4021a00032c9c0b5820b460412e9073d311f8ebbc4e931ca4cb709d491b5d50d06b6bfede0a959eba1b0d81825820c9f355431b2546acfc03b11540dc8bee31b9afc5674081a61cc39e0845380e7a010e81581c9fc430ea1f3adc20eebb813b2649e85c934ea5bc13d7b7fbe2b24e5010825839009fc430ea1f3adc20eebb813b2649e85c934ea5bc13d7b7fbe2b24e505064b671634d14cb8d543e71dd8eb437a47efb47b0b22882866c420d821b00000001f6b06007a7581c0d26f1decee50c24498585cb9cba2b6aa629c83023b327bb10fb67b9a14c4d696e7457697468647261770e581c22691d3d969ecf5802226290c2fb98e2bc08522d5b726c1f5f400105a3534275726e61626c65546f6b656e506c75747573014454657374181c5820accbfb633f637e3bb1abee40c9539d1effd742cd2716b3b1db9de3aaf3f3779401581c61d96f9000bf5d325da17258ee0693e19d441cecee64825289ee6b7da14c4d696e74576974686472617701581c966a0d009812f82bf198cfa1329602f48e0f600cff430de75ca90fc5a1476d79746f6b656e01581ccac67dd80f706e084b2aac605288b2ff793475ea43b2313e1ed384aba14454657374182a581cef6ed47a6917a3cbbeb46561e8853da969343794d66128598a34af2ca34d4275726e61626c65546f6b656e18574e4275726e61626c65546f6b656e3218f35820accbfb633f637e3bb1abee40c9539d1effd742cd2716b3b1db9de3aaf3f3779401581cf654f6a31f6c4cc2c39a169f2c022404aa9f19d43137b0448b219a3ea144546573741823111a004c4b4012818258204f184460ae3f3c15c6811f1380c3abc7bb73bf3cbbdffe874913c2410fc3577600a200818258200abb7b89e091dcd3201aea501854a4cb05290862d88b6eb30afa6dfd23f5446758403ccad89397ca9e583ae03b072b9ddf3b9c3840cde959339afc5c7c88d9a33b92599336baf7c46876806babfa04dd1b2bf7b77d35a4780b56eb5400d30dc908090581840000d8799f4d48656c6c6f2c20576f726c6421ff82196def1a0087f824f5f6",
		inputsHex:     "82825820c9f355431b2546acfc03b11540dc8bee31b9afc5674081a61cc39e0845380e7a008258204f184460ae3f3c15c6811f1380c3abc7bb73bf3cbbdffe874913c2410fc3577600",
		outputsHex:    "82a400581d70fdd6640d1c9a4392dd7e829f0cc4e26766539c48b2cf594959e33559011a00989680028201d8185822d8799f581c9fc430ea1f3adc20eebb813b2649e85c934ea5bc13d7b7fbe2b24e50ff03d81859010b820359010659010301010032323232323225333002323232323253330073370e900118041baa0011323232533300a3370e900018059baa00513232533300f30110021533300c3370e900018069baa003132533300d3371e6eb8c044c03cdd50042450d48656c6c6f2c20576f726c642100100114a06644646600200200644a66602600229404c94ccc044cdc79bae301500200414a2266006006002602a0026eb0c040c044c044c044c044c044c044c044c044c038dd50049bae3010300e37546020601c6ea800c5858dd7180780098061baa00516300d300e002300c001300937540022c6014601600460120026012004600e00260086ea8004526136565734aae7555cf2ab9f5742ae89a400581d70fdd6640d1c9a4392dd7e829f0cc4e26766539c48b2cf594959e33559011a00989680028201d8185822d8799f581c86b74c779bb9cf43532b357323b0ced1bdd6aa4276c45aee845f33feff03d81859010b820359010659010301010032323232323225333002323232323253330073370e900118041baa0011323232533300a3370e900018059baa00513232533300f30110021533300c3370e900018069baa003132533300d3371e6eb8c044c03cdd50042450d48656c6c6f2c20576f726c642100100114a06644646600200200644a66602600229404c94ccc044cdc79bae301500200414a2266006006002602a0026eb0c040c044c044c044c044c044c044c044c044c038dd50049bae3010300e37546020601c6ea800c5858dd7180780098061baa00516300d300e002300c001300937540022c6014601600460120026012004600e00260086ea8004526136565734aae7555cf2ab9f5742ae89",
		redeemerTag:   common.RedeemerTagSpend,
		redeemerIndex: 0,
		expectedCbor:  "d8799fd8799f9fd8799fd8799f5820c9f355431b2546acfc03b11540dc8bee31b9afc5674081a61cc39e0845380e7a00ffd8799fd8799fd87a9f581cfdd6640d1c9a4392dd7e829f0cc4e26766539c48b2cf594959e33559ffd87a80ffa140a1401a00989680d87b9fd8799f581c9fc430ea1f3adc20eebb813b2649e85c934ea5bc13d7b7fbe2b24e50ffffd8799f581cfdd6640d1c9a4392dd7e829f0cc4e26766539c48b2cf594959e33559ffffffff9fd8799fd8799f58204f184460ae3f3c15c6811f1380c3abc7bb73bf3cbbdffe874913c2410fc3577600ffd8799fd8799fd87a9f581cfdd6640d1c9a4392dd7e829f0cc4e26766539c48b2cf594959e33559ffd87a80ffa140a1401a00989680d87b9fd8799f581c86b74c779bb9cf43532b357323b0ced1bdd6aa4276c45aee845f33feffffd8799f581cfdd6640d1c9a4392dd7e829f0cc4e26766539c48b2cf594959e33559ffffffff9fd8799fd8799fd8799f581c9fc430ea1f3adc20eebb813b2649e85c934ea5bc13d7b7fbe2b24e50ffd8799fd8799fd8799f581c5064b671634d14cb8d543e71dd8eb437a47efb47b0b22882866c420dffffffffa140a1401a009569e4d87980d87a80ffff1a00032c9ca080a0d8799fd8799fd87980d87a80ffd8799fd87b80d87a80ffff9f581c9fc430ea1f3adc20eebb813b2649e85c934ea5bc13d7b7fbe2b24e50ffa1d87a9fd8799f5820c9f355431b2546acfc03b11540dc8bee31b9afc5674081a61cc39e0845380e7a00ffffd8799f4d48656c6c6f2c20576f726c6421ffa05820ac73d6545da30a8cc0395de0c2a5fa3ad99329f41d319901ebe2922f8554d5e3a080d87a80d87a80ffd8799f4d48656c6c6f2c20576f726c6421ffd87a9fd8799f5820c9f355431b2546acfc03b11540dc8bee31b9afc5674081a61cc39e0845380e7a00ffd8799fd8799f581c9fc430ea1f3adc20eebb813b2649e85c934ea5bc13d7b7fbe2b24e50ffffffff",
	},
	{
		name:          "Certificates",
		txHex:         "84a600818258200000000000000000000000000000000000000000000000000000000000000000000180049582008201581c2222222222222222222222222222222222222222222222222222222282008200581c0000000000000000000000000000000000000000000000000000000082018200581c000000000000000000000000000000000000000000000000000000008a03581c11111111111111111111111111111111111111111111111111111111582099999999999999999999999999999999999999999999999999999999999999991a000f4240190154d81e82011864581de000000000000000000000000000000000000000000000000000000000d901028080f68304581c1111111111111111111111111111111111111111111111111111111119053983078200581c000000000000000000000000000000000000000000000000000000001a002dc6c083088200581c000000000000000000000000000000000000000000000000000000001a002dc6c083098200581c000000000000000000000000000000000000000000000000000000008200581c0000000000000000000000000000000000000000000000000000000083098200581c000000000000000000000000000000000000000000000000000000008201581c0000000000000000000000000000000000000000000000000000000083098200581c00000000000000000000000000000000000000000000000000000000810283098200581c000000000000000000000000000000000000000000000000000000008103840a8200581c00000000000000000000000000000000000000000000000000000000581c111111111111111111111111111111111111111111111111111111118103840b8200581c00000000000000000000000000000000000000000000000000000000581c111111111111111111111111111111111111111111111111111111111a002dc6c0840c8200581c0000000000000000000000000000000000000000000000000000000081031a002dc6c0850d8200581c00000000000000000000000000000000000000000000000000000000581c1111111111111111111111111111111111111111111111111111111181031a002dc6c0830e8200581c000000000000000000000000000000000000000000000000000000008200581c22222222222222222222222222222222222222222222222222222222830f8200581c00000000000000000000000000000000000000000000000000000000f684108200581c000000000000000000000000000000000000000000000000000000001a002dc6c0f683118200581c000000000000000000000000000000000000000000000000000000001a002dc6c083128200581c00000000000000000000000000000000000000000000000000000000f683028201581c9b24324046544393443e1fb35c8b72c3c39e18a516a95df5f6654101581c1111111111111111111111111111111111111111111111111111111102182a151a00989680160ea20581840214d87980821a000f42401a05f5e1000781587d587b0101003232323232323225333333008001153330033370e900018029baa001153330073006375400224a66600894452615330054911856616c696461746f722072657475726e65642066616c73650013656002002002002002002153300249010b5f746d70313a20566f696400165734ae7155ceaab9e5573eae91f5f6",
		inputsHex:     "81825820000000000000000000000000000000000000000000000000000000000000000000",
		outputsHex:    "81a200581d6000000000000000000000000000000000000000000000000000000000011a000f4240",
		redeemerTag:   common.RedeemerTagCert,
		redeemerIndex: 20,
		expectedCbor:  "d8799fd8799f9fd8799fd8799f5820000000000000000000000000000000000000000000000000000000000000000000ffd8799fd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a80ffa140a1401a000f4240d87980d87a80ffffff8080182aa09fd8799fd87a9f581c22222222222222222222222222222222222222222222222222222222ffd87a80ffd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a80ffd87a9fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a80ffd905009f581c1111111111111111111111111111111111111111111111111111111158209999999999999999999999999999999999999999999999999999999999999999ffd905019f581c11111111111111111111111111111111111111111111111111111111190539ffd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a80ffd87a9fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a80ffd87b9fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a9fd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffffffffd87b9fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a9fd8799fd87a9f581c00000000000000000000000000000000000000000000000000000000ffffffffd87b9fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a9fd87a80ffffd87b9fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a9fd87b80ffffd87b9fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87b9f581c11111111111111111111111111111111111111111111111111111111d87b80ffffd87c9fd8799f581c00000000000000000000000000000000000000000000000000000000ffd8799f581c11111111111111111111111111111111111111111111111111111111ff1a002dc6c0ffd87c9fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a9fd87b80ff1a002dc6c0ffd87c9fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87b9f581c11111111111111111111111111111111111111111111111111111111d87b80ff1a002dc6c0ffd905029fd8799f581c00000000000000000000000000000000000000000000000000000000ffd8799f581c22222222222222222222222222222222222222222222222222222222ffffd905039fd8799f581c00000000000000000000000000000000000000000000000000000000ffffd87d9fd8799f581c00000000000000000000000000000000000000000000000000000000ff1a002dc6c0ffd87f9fd8799f581c00000000000000000000000000000000000000000000000000000000ff1a002dc6c0ffd87e9fd8799f581c00000000000000000000000000000000000000000000000000000000ffffd87b9fd87a9f581c9b24324046544393443e1fb35c8b72c3c39e18a516a95df5f6654101ffd8799f581c11111111111111111111111111111111111111111111111111111111ffffffa0d8799fd8799fd87980d87a80ffd8799fd87b80d87a80ffff80a1d87c9f14d87b9fd87a9f581c9b24324046544393443e1fb35c8b72c3c39e18a516a95df5f6654101ffd8799f581c11111111111111111111111111111111111111111111111111111111ffffffd87980a0582080bf68ced2c50b8734fc8cebd0a049e16e53d2fe5ec7e42822f07c263ced98aba080d8799f1a00989680ffd8799f0effffd87980d87c9f14d87b9fd87a9f581c9b24324046544393443e1fb35c8b72c3c39e18a516a95df5f6654101ffd8799f581c11111111111111111111111111111111111111111111111111111111ffffffff",
	},
	{
		name:          "Withdraw",
		txHex:         "84a700818258200000000000000000000000000000000000000000000000000000000000000000000183a2005839200000000000000000000000000000000000000000000000000000000011111111111111111111111111111111111111111111111111111111011a000f4240a200582340000000000000000000000000000000000000000000000000000000008198bd431b03011a000f4240a200582350111111111111111111111111111111111111111111111111111111118198bd431b03011a000f424002182a031a00448e0105a1581df004036eecadc2f19e95f831b4bc08919cde1d1088d74602bd3dcd78a2000e81581c000000000000000000000000000000000000000000000000000000001601a10582840000d87a81d87980821a000f42401a05f5e100840300d87980821a000f42401a05f5e100f5f6",
		inputsHex:     "81825820000000000000000000000000000000000000000000000000000000000000000000",
		outputsHex:    "81a40058393004036eecadc2f19e95f831b4bc08919cde1d1088d74602bd3dcd78a204036eecadc2f19e95f831b4bc08919cde1d1088d74602bd3dcd78a2011a000f4240028201d81843d8798003d818590221820359021c5902190101003232323232323232322232533333300c00215323330073001300937540062a660109211c52756e6e696e672032206172672076616c696461746f72206d696e740013533333300d004153330073001300937540082a66601660146ea8010494ccc021288a4c2a660129211856616c696461746f722072657475726e65642066616c7365001365600600600600600600600315330084911d52756e6e696e672033206172672076616c696461746f72207370656e640013533333300d004153330073001300937540082a66601660146ea8010494cccccc03800454ccc020c008c028dd50008a99980618059baa0011253330094a22930a998052491856616c696461746f722072657475726e65642066616c73650013656006006006006006006006006006006006006300c300a37540066e1d2000153300700116153300700116153300700116153300700116490191496e636f72726563742072656465656d6572207479706520666f722076616c696461746f72207370656e642e0a2020202020202020202020202020202020202020446f75626c6520636865636b20796f7520686176652077726170706564207468652072656465656d657220747970652061732073706563696669656420696e20796f757220706c757475732e6a736f6e0015330034910b5f746d70313a20566f6964001615330024910b5f746d70303a20566f696400165734ae7155ceaab9e5573eae855d21",
		redeemerTag:   common.RedeemerTagReward,
		redeemerIndex: 0,
		slotState:     preprodSlotState,
		expectedCbor:  "d8799fd8799f9fd8799fd8799f5820000000000000000000000000000000000000000000000000000000000000000000ffd8799fd8799fd87a9f581c04036eecadc2f19e95f831b4bc08919cde1d1088d74602bd3dcd78a2ffd8799fd8799fd87a9f581c04036eecadc2f19e95f831b4bc08919cde1d1088d74602bd3dcd78a2ffffffffa140a1401a000f4240d87b9fd87980ffd8799f581c04036eecadc2f19e95f831b4bc08919cde1d1088d74602bd3dcd78a2ffffffff809fd8799fd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffd8799fd8799fd87a9f581c11111111111111111111111111111111111111111111111111111111ffffffffa140a1401a000f4240d87980d87a80ffd8799fd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffd8799fd87a9f1a00261ec3181b03ffffffa140a1401a000f4240d87980d87a80ffd8799fd8799fd87a9f581c11111111111111111111111111111111111111111111111111111111ffd8799fd87a9f1a00261ec3181b03ffffffa140a1401a000f4240d87980d87a80ffff182aa080a1d87a9f581c04036eecadc2f19e95f831b4bc08919cde1d1088d74602bd3dcd78a2ff00d8799fd8799fd87980d87a80ffd8799fd87a9f1b000001739c890420ffd87980ffff9f581c00000000000000000000000000000000000000000000000000000000ffa2d87a9fd8799f5820000000000000000000000000000000000000000000000000000000000000000000ffffd87a81d87980d87b9fd87a9f581c04036eecadc2f19e95f831b4bc08919cde1d1088d74602bd3dcd78a2ffffd87980a0582040bee3b25a585a854fe73f3448a6f6b417fe669c813a1881e665971f34a9e984a080d87a80d8799f01ffffd87980d87b9fd87a9f581c04036eecadc2f19e95f831b4bc08919cde1d1088d74602bd3dcd78a2ffffff",
	},
	{
		name:          "Voting",
		txHex:         "84a40081825820000000000000000000000000000000000000000000000000000000000000000000018002182a13a58200581c00000000000000000000000000000000000000000000000000000000a1825820999999999999999999999999999999999999999999999999999999999999999918988200827668747470733a2f2f61696b656e2d6c616e672e6f7267582000000000000000000000000000000000000000000000000000000000000000008202581c00000000000000000000000000000000000000000000000000000000a38258209999999999999999999999999999999999999999999999999999999999999999008202f68258208888888888888888888888888888888888888888888888888888888888888888018202f68258207777777777777777777777777777777777777777777777777777777777777777028202f68203581c43fa47afc68a7913fbe2f400e3849cb492d9a2610c85966de0f2ba1ea18258209999999999999999999999999999999999999999999999999999999999999999038200f68204581c00000000000000000000000000000000000000000000000000000000a18258209999999999999999999999999999999999999999999999999999999999999999048201f68201581c43fa47afc68a7913fbe2f400e3849cb492d9a2610c85966de0f2ba1ea18258209999999999999999999999999999999999999999999999999999999999999999018201f6a20582840402d87980821a000f42401a05f5e100840400d87981182a821a000f42401a05f5e1000781587d587b0101003232323232323225333333008001153330033370e900018029baa001153330073006375400224a66600894452615330054911856616c696461746f722072657475726e65642066616c73650013656002002002002002002153300249010b5f746d70303a20566f696400165734ae7155ceaab9e5573eae91f5f6",
		inputsHex:     "81825820000000000000000000000000000000000000000000000000000000000000000000",
		outputsHex:    "81a200581d6000000000000000000000000000000000000000000000000000000000011a000f4240",
		redeemerTag:   lcommon.RedeemerTagVoting,
		redeemerIndex: 0,
		// NOTE: this is slightly different than what's produced by the Aiken tests
		// The Aiken test is "wrong" because the redeemer datum redefined in the test definition
		// uses indef-length encoding while the in-TX redeemer datum uses def-length encoding
		expectedCbor: "d8799fd8799f9fd8799fd8799f5820000000000000000000000000000000000000000000000000000000000000000000ffd8799fd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a80ffa140a1401a000f4240d87980d87a80ffffff8080182aa080a0d8799fd8799fd87980d87a80ffd8799fd87b80d87a80ffff80a2d87d9fd8799fd87a9f581c43fa47afc68a7913fbe2f400e3849cb492d9a2610c85966de0f2ba1effffffd87981182ad87d9fd87a9fd87a9f581c43fa47afc68a7913fbe2f400e3849cb492d9a2610c85966de0f2ba1effffffd87980a05820e042ea3e95cf8156842e35639778441becaf3c862cb9459ee74b44aeeb88c673a5d8799fd87a9f581c43fa47afc68a7913fbe2f400e3849cb492d9a2610c85966de0f2ba1effffa1d8799f5820999999999999999999999999999999999999999999999999999999999999999901ffd87a80d8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffffa1d8799f582099999999999999999999999999999999999999999999999999999999999999991898ffd87980d87a9fd87a9f581c43fa47afc68a7913fbe2f400e3849cb492d9a2610c85966de0f2ba1effffa1d8799f5820999999999999999999999999999999999999999999999999999999999999999903ffd87980d87a9fd8799f581c00000000000000000000000000000000000000000000000000000000ffffa3d8799f5820777777777777777777777777777777777777777777777777777777777777777702ffd87b80d8799f5820888888888888888888888888888888888888888888888888888888888888888801ffd87b80d8799f5820999999999999999999999999999999999999999999999999999999999999999900ffd87b80d87b9f581c00000000000000000000000000000000000000000000000000000000ffa1d8799f5820999999999999999999999999999999999999999999999999999999999999999904ffd87a8080d87a80d87a80ffd87981182ad87d9fd8799fd87a9f581c43fa47afc68a7913fbe2f400e3849cb492d9a2610c85966de0f2ba1effffffff",
	},
	{
		name:          "ProposeAllButPparams",
		txHex:         "84a40081825820000000000000000000000000000000000000000000000000000000000000000000018002182a14d9010289841a001e8480581df0000000000000000000000000000000000000000000000000000000008301f6820a00827668747470733a2f2f61696b656e2d6c616e672e6f726758200000000000000000000000000000000000000000000000000000000000000000841a001e8480581df0000000000000000000000000000000000000000000000000000000008301825820000000000000000000000000000000000000000000000000000000000000000000820b00827668747470733a2f2f61696b656e2d6c616e672e6f726758200000000000000000000000000000000000000000000000000000000000000000841a001e8480581df0000000000000000000000000000000000000000000000000000000008302a1581de0111111111111111111111111111111111111111111111111111111111a000f4240f6827668747470733a2f2f61696b656e2d6c616e672e6f726758200000000000000000000000000000000000000000000000000000000000000000841a001e8480581df0000000000000000000000000000000000000000000000000000000008302a1581de0222222222222222222222222222222222222222222222222222222221a000f4240581c9b24324046544393443e1fb35c8b72c3c39e18a516a95df5f6654101827668747470733a2f2f61696b656e2d6c616e672e6f726758200000000000000000000000000000000000000000000000000000000000000000841a001e8480581df0000000000000000000000000000000000000000000000000000000008203f6827668747470733a2f2f61696b656e2d6c616e672e6f726758200000000000000000000000000000000000000000000000000000000000000000841a001e8480581df0000000000000000000000000000000000000000000000000000000008504f6818200581c00000000000000000000000000000000000000000000000000000000a18200581c000000000000000000000000000000000000000000000000000000001901f4d81e820102827668747470733a2f2f61696b656e2d6c616e672e6f726758200000000000000000000000000000000000000000000000000000000000000000841a001e8480581df0000000000000000000000000000000000000000000000000000000008305f68282782068747470733a2f2f636f6e737469747574696f6e2e63617264616e6f2e6f726758200000000000000000000000000000000000000000000000000000000000000000f6827668747470733a2f2f61696b656e2d6c616e672e6f726758200000000000000000000000000000000000000000000000000000000000000000841a001e8480581df0000000000000000000000000000000000000000000000000000000008305f68282782068747470733a2f2f636f6e737469747574696f6e2e63617264616e6f2e6f726758200000000000000000000000000000000000000000000000000000000000000000581c00000000000000000000000000000000000000000000000000000000827668747470733a2f2f61696b656e2d6c616e672e6f726758200000000000000000000000000000000000000000000000000000000000000000841a001e8480581de0000000000000000000000000000000000000000000000000000000008106827668747470733a2f2f61696b656e2d6c616e672e6f726758200000000000000000000000000000000000000000000000000000000000000000a20581840503d87980821a000f42401a05f5e1000781587d587b0101003232323232323225333333008001153330033370e900018029baa001153330073006375400224a66600894452615330054911856616c696461746f722072657475726e65642066616c73650013656002002002002002002153300249010b5f746d70313a20566f696400165734ae7155ceaab9e5573eae91f5f6",
		inputsHex:     "81825820000000000000000000000000000000000000000000000000000000000000000000",
		outputsHex:    "81a200581d6000000000000000000000000000000000000000000000000000000000011a000f4240",
		redeemerTag:   lcommon.RedeemerTagProposing,
		redeemerIndex: 3,
		expectedCbor:  "d8799fd8799f9fd8799fd8799f5820000000000000000000000000000000000000000000000000000000000000000000ffd8799fd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a80ffa140a1401a000f4240d87980d87a80ffffff8080182aa080a0d8799fd8799fd87980d87a80ffd8799fd87b80d87a80ffff80a1d87e9f03d8799f1a001e8480d87a9f581c00000000000000000000000000000000000000000000000000000000ffd87b9fa1d8799f581c22222222222222222222222222222222222222222222222222222222ff1a000f4240d8799f581c9b24324046544393443e1fb35c8b72c3c39e18a516a95df5f6654101ffffffffd87980a05820644c54128c2d5a09a7b5cf1f533ffabac64975224bd6e8f6443d2932ba61fccda09fd8799f1a001e8480d87a9f581c00000000000000000000000000000000000000000000000000000000ffd87a9fd87a80d8799f0a00ffffffd8799f1a001e8480d87a9f581c00000000000000000000000000000000000000000000000000000000ffd87a9fd8799fd8799f5820000000000000000000000000000000000000000000000000000000000000000000ffffd8799f0b00ffffffd8799f1a001e8480d87a9f581c00000000000000000000000000000000000000000000000000000000ffd87b9fa1d8799f581c11111111111111111111111111111111111111111111111111111111ff1a000f4240d87a80ffffd8799f1a001e8480d87a9f581c00000000000000000000000000000000000000000000000000000000ffd87b9fa1d8799f581c22222222222222222222222222222222222222222222222222222222ff1a000f4240d8799f581c9b24324046544393443e1fb35c8b72c3c39e18a516a95df5f6654101ffffffd8799f1a001e8480d87a9f581c00000000000000000000000000000000000000000000000000000000ffd87c9fd87a80ffffd8799f1a001e8480d87a9f581c00000000000000000000000000000000000000000000000000000000ffd87d9fd87a809fd8799f581c00000000000000000000000000000000000000000000000000000000ffffa1d8799f581c00000000000000000000000000000000000000000000000000000000ff1901f4d8799f0102ffffffd8799f1a001e8480d87a9f581c00000000000000000000000000000000000000000000000000000000ffd87e9fd87a80d8799fd87a80ffffffd8799f1a001e8480d87a9f581c00000000000000000000000000000000000000000000000000000000ffd87e9fd87a80d8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffffffffd8799f1a001e8480d8799f581c00000000000000000000000000000000000000000000000000000000ffd87f80ffffd87a80d87a80ffd87980d87e9f03d8799f1a001e8480d87a9f581c00000000000000000000000000000000000000000000000000000000ffd87b9fa1d8799f581c22222222222222222222222222222222222222222222222222222222ff1a000f4240d8799f581c9b24324046544393443e1fb35c8b72c3c39e18a516a95df5f6654101ffffffffff",
	},
	{
		name:          "ProposePparamsNoCostModels",
		txHex:         "84a40081825820000000000000000000000000000000000000000000000000000000000000000000018002182a14d9010281841a001e8480581df0000000000000000000000000000000000000000000000000000000008400f6b81d00182c011a00025ef50712081901f409d81e82030a0ad81e82031903e80bd81e82020a021a00016000031940000419044c051a001e8480061a1dcd650010190154111910d61382d81e821902411903e8d81e821902d11a000f424014821a00d59f801b00000002540be40015821a03b20b801b00000004a817c80016191388171896181803181985d81e8218331864d81e8218341864d81e8218351864d81e8218361864d81e8218371864181a8ad81e8218431864d81e8218431864d81e82183c1864d81e82184b1864d81e82183c1864d81e8218431864d81e8218431864d81e8218431864d81e82184b1864d81e8218431864181b07181c1892181d06181e1b000000174876e800181f1a1dcd65001820141821d81e820f01581c9b24324046544393443e1fb35c8b72c3c39e18a516a95df5f6654101827668747470733a2f2f61696b656e2d6c616e672e6f726758200000000000000000000000000000000000000000000000000000000000000000a20581840500d87980821a000f42401a05f5e1000781587d587b0101003232323232323225333333008001153330033370e900018029baa001153330073006375400224a66600894452615330054911856616c696461746f722072657475726e65642066616c73650013656002002002002002002153300249010b5f746d70313a20566f696400165734ae7155ceaab9e5573eae91f5f6",
		inputsHex:     "81825820000000000000000000000000000000000000000000000000000000000000000000",
		outputsHex:    "81a200581d6000000000000000000000000000000000000000000000000000000000011a000f4240",
		redeemerTag:   lcommon.RedeemerTagProposing,
		redeemerIndex: 0,
		expectedCbor:  "d8799fd8799f9fd8799fd8799f5820000000000000000000000000000000000000000000000000000000000000000000ffd8799fd8799fd8799f581c00000000000000000000000000000000000000000000000000000000ffd87a80ffa140a1401a000f4240d87980d87a80ffffff8080182aa080a0d8799fd8799fd87980d87a80ffd8799fd87b80d87a80ffff80a1d87e9f00d8799f1a001e8480d87a9f581c00000000000000000000000000000000000000000000000000000000ffd8799fd87a80b81d00182c011a00025ef5021a00016000031940000419044c051a001e8480061a1dcd65000712081901f4099f030aff0a9f031903e8ff0b9f0105ff10190154111910d6139f9f1902411903e8ff9f1902d11a000f4240ffff149f1a00d59f801b00000002540be400ff159f1a03b20b801b00000004a817c800ff1619138817189618180318199f9f18331864ff9f0d1819ff9f18351864ff9f181b1832ff9f0b14ffff181a9f9f18431864ff9f18431864ff9f0305ff9f0304ff9f0305ff9f18431864ff9f18431864ff9f18431864ff9f0304ff9f18431864ffff181b07181c1892181d06181e1b000000174876e800181f1a1dcd650018201418219f0f01ffd8799f581c9b24324046544393443e1fb35c8b72c3c39e18a516a95df5f6654101ffffffffd87980a05820a88a9bf8af51ea738bf212fe204e5ef2fd05312c995dad1ec194dcdc5aa07737a09fd8799f1a001e8480d87a9f581c00000000000000000000000000000000000000000000000000000000ffd8799fd87a80b81d00182c011a00025ef5021a00016000031940000419044c051a001e8480061a1dcd65000712081901f4099f030aff0a9f031903e8ff0b9f0105ff10190154111910d6139f9f1902411903e8ff9f1902d11a000f4240ffff149f1a00d59f801b00000002540be400ff159f1a03b20b801b00000004a817c800ff1619138817189618180318199f9f18331864ff9f0d1819ff9f18351864ff9f181b1832ff9f0b14ffff181a9f9f18431864ff9f18431864ff9f0305ff9f0304ff9f0305ff9f18431864ff9f18431864ff9f18431864ff9f0304ff9f18431864ffff181b07181c1892181d06181e1b000000174876e800181f1a1dcd650018201418219f0f01ffd8799f581c9b24324046544393443e1fb35c8b72c3c39e18a516a95df5f6654101ffffffffd87a80d87a80ffd87980d87e9f00d8799f1a001e8480d87a9f581c00000000000000000000000000000000000000000000000000000000ffd8799fd87a80b81d00182c011a00025ef5021a00016000031940000419044c051a001e8480061a1dcd65000712081901f4099f030aff0a9f031903e8ff0b9f0105ff10190154111910d6139f9f1902411903e8ff9f1902d11a000f4240ffff149f1a00d59f801b00000002540be400ff159f1a03b20b801b00000004a817c800ff1619138817189618180318199f9f18331864ff9f0d1819ff9f18351864ff9f181b1832ff9f0b14ffff181a9f9f18431864ff9f18431864ff9f0305ff9f0304ff9f0305ff9f18431864ff9f18431864ff9f18431864ff9f0304ff9f18431864ffff181b07181c1892181d06181e1b000000174876e800181f1a1dcd650018201418219f0f01ffd8799f581c9b24324046544393443e1fb35c8b72c3c39e18a516a95df5f6654101ffffffffff",
	},
}

func TestScriptContextV3(t *testing.T) {
	for _, testDef := range scriptContextV3TestDefs {
		t.Run(
			testDef.name,
			func(t *testing.T) {
				txInfo, err := buildTxInfoV3(
					testDef.slotState,
					testDef.txHex,
					testDef.inputsHex,
					testDef.outputsHex,
				)
				if err != nil {
					t.Fatalf("unexpected error: %s", err)
				}

				// Extract purpose and redeemer from TxInfo
				var purpose ScriptInfo
				var redeemer Redeemer
				for _, redeemerPair := range txInfo.(TxInfoV3).Redeemers {
					if redeemerPair.Value.Tag == testDef.redeemerTag &&
						redeemerPair.Value.Index == testDef.redeemerIndex {
						purpose = redeemerPair.Key
						redeemer = redeemerPair.Value
						break
					}
				}
				// Build script context
				sc := NewScriptContextV3(txInfo, redeemer, purpose)
				scCbor, err := data.Encode(sc.ToPlutusData())
				if err != nil {
					t.Fatalf("unexpected error: %s", err)
				}
				scCborHex := hex.EncodeToString(scCbor)
				if scCborHex != testDef.expectedCbor {
					t.Fatalf(
						"did not get expected ScriptContext CBOR\n     got: %s\n  wanted: %s",
						scCborHex,
						testDef.expectedCbor,
					)
				}
			},
		)
	}
}
